# Flow Alerts

The module of flow alerts has several behavioral techniques to detect attacks by analyzing the content of each flow alone.

The detection techniques are:

- Long connections
- Successful SSH connections 
- Connections without DNS resolution
- DNS resolutions to IPs that were never used
- Connections to unknown ports
- Data exfiltration
- Malicious JA3 hashes
- Connections to port 0
- Multiple reconnection attempts 
- Alerts from Zeek: Self-signed certs, invalid certs, port-scans and address scans, and password guessing 
- DGA
- Connection to multiple ports
- Malicious SSL certificates

The details of each detection follows.


## Long Connections
Detect connections that are long, except the multicast connections.

By defualt, A connection in considered long if it exceeds 1500 seconds (25 Minutes). 

This threshold can be changed ```slips.conf``` by changing the value of  ```long_connection_threshold```  

## Connections without DNS resolution
This will detect connections done without a previous DNS resolution. The idea is that a connection without a DNS resolution is slightly suspicious.

If Slips runs by capturing packets directly from a network device (as opposed to, for example, a PCAP file), this detection will ignore all connections that happen in the first 3 minute of operation of Slips. This is because most times Slips is started when the computer is already running, and many DNS connections were already done. So waiting 3 minutes decreases the amount of False Positives.

This detection will ignore certain IP addresses for which a connection without DNS is ok. The exceptions are:

- Private IPs
- Localhost IPs (127.0.0.0/8)
- Reserved IPs (including the super broadcast 255.255.255.255)
- IPv6 local-link IPs
- Multicast IPs
- Broadcast IPs only if they are private


## Successful SSH connections

Slips detects successful SSH connections using 2 ways

1. Using Zeek. Zeek logs successful SSH connection to ssh.log by default
2. if all bytes sent in a SSH connection is more than 4290 bytes

## DNS resolutions without a connection
This will detect DNS resolutions for which no further connection was done. A resolution without a usage is slightly suspicious.

The domains that are excepted are:

- All reverse DNS resolutions using the in-addr.arpa domain.
- All .local domains
- The wild card domain *
- Subdomains of cymru.com, since it is used by the ipwhois library to get the ASN of an IP and its range.
- Ignore WPAD domain from Windows
- Ignore domains without a TLD such as the Chrome test domains.



## Connection to unknown ports

Slips has a list of known ports located in ```slips_files/ports_info/ports_used_by_specific_orgs.csv```

It also has a list of ports that belong to a specific organization in ```slips_files/ports_info/ports_used_by_specific_orgs.csv```

For example, even though 5223/TCP isn't a well known port, Apple uses it in Apple Push Notification Service (APNS). 

any port that isn't in the above 2 files is considered unknown to Slips.

## Data exfiltration

Slips generate a 'possible data exfiltration alerts when the number of uploaded files to any IP exceeds 700 MBs.

The number of MBs can be modified by editting the value of ```data_exfiltration_threshold``` in ```slips.conf``` 

## Malicious JA3 and JA3s hashes

Slips uses JA3 hashes to detect C&C servers (JA3s) and infected clients (JA3)

Slips is shipped with it’s own zeek scripts that add JA3 and JA3s fingerprints to the SSL log files generated by zeek.

Slips supports JA3 feeds in addition to having more than 40 different threat intelligence feeds. 
The JA3 feeds contain JA3 fingerprints that are identified as malicious. 
The JA3 threat intelligence feed used by Slips now is Abuse.ch JA3 feed.
And you can add other JA3 TI feeds in ```ja3_feeds``` in ```slips.conf```.

## Connections to port 0

There has been a significant rise in the number of attacks listed as Port 0.
Last year, these equated to 10% of all attacks, but now it’s up to almost 25%. 

Slips detects any connection to port 0 using any protocol other than 'IGMP' and 'ICMP' as malicious.


## Multiple reconnection attempts 

Multiple reconnection attempts in Slips are 5 or more not established flows (reconnections) to the same destination port.



## Zeek alerts

By default, Slips depends on Zeek for detecting different behaviours, for example 
Self-signed certs, invalid certs, port-scans and address scans, and password guessing.

Some scans are also detected by Slips independently of Zeek, like ICMP sweeps and vertical/horizontal portscans.
Check  []() section for more info #todo


## DGA

When the DNS server fails to resolve a domain, it responds back with NXDOMAIN code.

To detect DGA, Slips will count the amount of NXDOMAINs met in the DNS traffic of each source IP.

Then we alert when there is 10 or more NXDOMAINs.

Every 10,15,20 ..etc slips generates an evidence.

## Connection to multiple ports

When Slips encounters a connection to or from a specific IP and a specific port, it scans previous connections looking for connection to/from that same IP using a different port.

It alerts when finding two or more connections to the same IP.

## Malicious SSL certificates

Slips uses SSL certificates sha1 hashes to detect C&C servers.

Slips supports SSL feeds and is shipped with Abuse.ch feed of malicious SSL hashes by default. 
And you can add other SSL feeds in ```ssl_feeds``` in ```slips.conf```.


---

With every generated evidence, Slips gathers as much info 
about the malicious IP and prints it with the alert.

So instead of having an alerts saying:

    Detected SSL certificate validation failed with (certificate has expired) Destination IP: 216.58.201.70.

Slips gathers AS, hostname, SNI, rDNS and any available data about this IP and you get an alert saying:

    Detected SSL certificate validation failed with (certificate has expired) Destination IP: 
    216.58.201.70. AS: GOOGLE, US, SNI: 2542116.fls.doubleclick.net, rDNS: prg03s01-in-f70.1e100.net

